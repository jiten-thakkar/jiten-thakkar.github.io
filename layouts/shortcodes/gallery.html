<!-- Enhanced Gallery shortcode with lightbox and multiple layouts -->
{{ $pattern := .Get "pattern" | default "*.{jpg,jpeg,png,gif,webp}" }}
{{ $columns := .Get "columns" | default "3" }}
{{ $gap := .Get "gap" | default "1rem" }}
{{ $height := .Get "height" | default "250px" }}

<div class="photo-gallery gallery-cols-{{ $columns }}" style="gap: {{ $gap }};">
  {{ range (.Page.Resources.Match $pattern) }}
    <div class="gallery-item">
      <a href="{{ .RelPermalink }}" class="gallery-link" data-lightbox="gallery" data-title="{{ .Title }}">
        <img src="{{ .RelPermalink }}"
             alt="{{ .Title | default .Name }}"
             loading="lazy"
             style="height: {{ $height }};">
      </a>
      {{ with .Title }}
        <span class="gallery-caption">{{ . }}</span>
      {{ end }}
    </div>
  {{ end }}
</div>

<style>
.photo-gallery {
  display: grid;
  margin: 2rem 0;
}

.gallery-cols-2 {
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
}

.gallery-cols-3 {
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
}

.gallery-cols-4 {
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
}

.gallery-item {
  position: relative;
  overflow: hidden;
  border-radius: 8px;
  background: var(--entry);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.gallery-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

.gallery-link {
  display: block;
  position: relative;
  overflow: hidden;
}

.gallery-item img {
  width: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
  display: block;
}

.gallery-item:hover img {
  transform: scale(1.1);
}

.gallery-caption {
  display: block;
  padding: 0.75rem;
  font-size: 0.875rem;
  text-align: center;
  color: var(--secondary);
  background: var(--entry);
}

/* Lightbox overlay */
.lightbox-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.95);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  cursor: pointer;
}

.lightbox-overlay.active {
  display: flex;
}

.lightbox-content {
  max-width: 90vw;
  max-height: 90vh;
  position: relative;
}

.lightbox-image {
  max-width: 90vw;
  max-height: 90vh;
  object-fit: contain;
}

.lightbox-caption {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  background: rgba(0, 0, 0, 0.7);
  padding: 0.5rem 1rem;
  border-radius: 4px;
  font-size: 0.875rem;
}

.lightbox-close {
  position: absolute;
  top: 20px;
  right: 20px;
  color: white;
  font-size: 2rem;
  cursor: pointer;
  background: rgba(0, 0, 0, 0.5);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.3s ease;
}

.lightbox-close:hover {
  background: rgba(0, 0, 0, 0.8);
}

.lightbox-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  color: white;
  font-size: 2rem;
  cursor: pointer;
  background: rgba(0, 0, 0, 0.5);
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.3s ease;
  user-select: none;
}

.lightbox-nav:hover {
  background: rgba(0, 0, 0, 0.8);
}

.lightbox-prev {
  left: 20px;
}

.lightbox-next {
  right: 20px;
}

/* Responsive */
@media (max-width: 768px) {
  .photo-gallery {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important;
  }

  .gallery-item img {
    height: 150px !important;
  }
}
</style>

<script>
(function() {
  // Simple lightbox implementation
  let currentIndex = 0;
  let galleryImages = [];

  // Create lightbox overlay
  const createLightbox = () => {
    const overlay = document.createElement('div');
    overlay.className = 'lightbox-overlay';
    overlay.innerHTML = `
      <div class="lightbox-close">&times;</div>
      <div class="lightbox-nav lightbox-prev">&lsaquo;</div>
      <div class="lightbox-content">
        <img class="lightbox-image" src="" alt="">
        <div class="lightbox-caption"></div>
      </div>
      <div class="lightbox-nav lightbox-next">&rsaquo;</div>
    `;
    document.body.appendChild(overlay);
    return overlay;
  };

  const lightbox = createLightbox();
  const lightboxImg = lightbox.querySelector('.lightbox-image');
  const lightboxCaption = lightbox.querySelector('.lightbox-caption');

  // Collect all gallery images
  document.querySelectorAll('.gallery-link').forEach((link, index) => {
    galleryImages.push({
      src: link.href,
      title: link.dataset.title || ''
    });

    link.addEventListener('click', (e) => {
      e.preventDefault();
      currentIndex = index;
      showLightbox();
    });
  });

  const showLightbox = () => {
    const image = galleryImages[currentIndex];
    lightboxImg.src = image.src;
    lightboxCaption.textContent = image.title;
    lightboxCaption.style.display = image.title ? 'block' : 'none';
    lightbox.classList.add('active');
  };

  const hideLightbox = () => {
    lightbox.classList.remove('active');
  };

  const showNext = () => {
    currentIndex = (currentIndex + 1) % galleryImages.length;
    showLightbox();
  };

  const showPrev = () => {
    currentIndex = (currentIndex - 1 + galleryImages.length) % galleryImages.length;
    showLightbox();
  };

  // Event listeners
  lightbox.querySelector('.lightbox-close').addEventListener('click', hideLightbox);
  lightbox.querySelector('.lightbox-next').addEventListener('click', (e) => {
    e.stopPropagation();
    showNext();
  });
  lightbox.querySelector('.lightbox-prev').addEventListener('click', (e) => {
    e.stopPropagation();
    showPrev();
  });

  lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox) {
      hideLightbox();
    }
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!lightbox.classList.contains('active')) return;

    if (e.key === 'Escape') hideLightbox();
    if (e.key === 'ArrowRight') showNext();
    if (e.key === 'ArrowLeft') showPrev();
  });
})();
</script>
